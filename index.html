<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>APPä½“éªŒé—®å·è°ƒæŸ¥</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    h1 {
      text-align: center;
      color: #333;
      font-size: 22px;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 24px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ddd;
      transition: all 0.3s;
    }

    .step-dot.active {
      background: #667eea;
      transform: scale(1.2);
    }

    .step-dot.completed {
      background: #4caf50;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .required::after {
      content: '*';
      color: #f44336;
      margin-left: 4px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="datetime-local"],
    select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .checkbox-item:hover {
      background: #e8f0fe;
    }

    .checkbox-item.selected {
      background: #e8f0fe;
      border-color: #667eea;
    }

    .checkbox-item input {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }

    .score-display {
      text-align: center;
      font-size: 64px;
      font-weight: bold;
      color: #667eea;
      margin: 20px 0;
    }

    .score-labels {
      display: flex;
      justify-content: space-between;
      color: #666;
      font-size: 12px;
      margin-top: 8px;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(to right, #f44336, #ff9800, #4caf50);
      border-radius: 4px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 32px;
      height: 32px;
      background: white;
      border: 3px solid #667eea;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      margin-top: 10px;
    }

    .hidden {
      display: none !important;
    }

    .step-section {
      display: none;
    }

    .step-section.active {
      display: block;
    }

    .alert {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
    }

    .alert-warning {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffcc80;
    }

    .alert-success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    .alert-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #4caf50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .success-icon svg {
      width: 40px;
      height: 40px;
      fill: white;
    }

    .success-message {
      text-align: center;
    }

    .success-message h2 {
      color: #333;
      margin-bottom: 10px;
    }

    .success-message p {
      color: #666;
    }

    .device-info {
      background: #f0f4ff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      color: #5c6bc0;
      margin-bottom: 20px;
    }

    .device-info strong {
      color: #3949ab;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .admin-link {
      text-align: center;
      margin-top: 20px;
    }

    .admin-link a {
      color: rgba(255,255,255,0.8);
      font-size: 12px;
      text-decoration: none;
    }

    .admin-link a:hover {
      color: white;
      text-decoration: underline;
    }

    .time-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .time-row .form-group {
      margin-bottom: 0;
    }

    .app-select-container {
      position: relative;
    }

    .app-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .app-tag {
      padding: 8px 16px;
      background: #f0f4ff;
      border: 2px solid transparent;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .app-tag:hover {
      background: #e0e8ff;
    }

    .app-tag.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* åŒè¾“å…¥æ¡†æ ·å¼ */
    .dual-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dual-input input {
      flex: 1;
    }

    .dual-separator {
      color: #999;
      font-size: 14px;
      white-space: nowrap;
    }

    .input-hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
    }

    .input-hint.error {
      color: #f44336;
    }

    .input-hint.success {
      color: #4caf50;
    }

    /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .upload-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #666;
      font-size: 14px;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f5;
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-item .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 24px;
    }

    .preview-item .remove-btn:hover {
      background: rgba(244,67,54,0.9);
    }

    @media (max-width: 400px) {
      body {
        padding: 10px;
      }
      
      .card {
        padding: 18px;
      }

      h1 {
        font-size: 20px;
      }

      .time-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ­¥éª¤1: åŸºç¡€ä¿¡æ¯ -->
    <div class="step-section active" id="step-basic">
      <div class="card">
        <h1>APPä½“éªŒé—®å·è°ƒæŸ¥</h1>
        <p class="subtitle">è¯·å¡«å†™æ‚¨çš„åŸºæœ¬ä¿¡æ¯</p>
        
        <div class="step-indicator">
          <div class="step-dot active"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
        </div>

        <div class="device-info" id="deviceInfo">
          è®¾å¤‡ID: <strong id="deviceIdDisplay">åŠ è½½ä¸­...</strong>
        </div>

        <div id="duplicateWarning" class="alert alert-warning hidden">
          <strong>æç¤ºï¼š</strong>è¯¥è®¾å¤‡å·²æäº¤è¿‡é—®å·ï¼Œæ‚¨ä»å¯ç»§ç»­å¡«å†™æ–°çš„ä½“éªŒåé¦ˆã€‚
        </div>

        <div class="form-group">
          <label class="required">å§“å</label>
          <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
        </div>

        <div class="form-group">
          <label class="required">æ‰‹æœºå·</label>
          <input type="tel" id="userPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·" maxlength="11">
        </div>

        <div class="form-group">
          <label class="required">å¾®ä¿¡å· / WUIDï¼ˆä»»å¡«ä¸€é¡¹ï¼‰</label>
          <div class="dual-input">
            <input type="text" id="userWechat" placeholder="å¾®ä¿¡å·" oninput="checkDualInput()">
            <span class="dual-separator">æˆ–</span>
            <input type="text" id="userWuid" placeholder="WUID" oninput="checkDualInput()">
          </div>
          <p class="input-hint" id="dualInputHint">è¯·è‡³å°‘å¡«å†™å¾®ä¿¡å·æˆ–WUIDä¸­çš„ä¸€é¡¹</p>
        </div>

        <button class="btn btn-primary" onclick="goToStep2()">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤2: APPä½“éªŒè®°å½• -->
    <div class="step-section" id="step-app">
      <div class="card">
        <h1>APPä½“éªŒè®°å½•</h1>
        <p class="subtitle">è¯·é€‰æ‹©æ‚¨ä½“éªŒçš„APPå¹¶è®°å½•æ—¶é—´</p>
        
        <div class="step-indicator">
          <div class="step-dot completed"></div>
          <div class="step-dot active"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
        </div>

        <div class="form-group">
          <label class="required">é€‰æ‹©ä½“éªŒçš„APP</label>
          <div class="app-list" id="appList">
            <span class="app-tag" onclick="selectApp(this, 'è…¾è®¯è§†é¢‘')">è…¾è®¯è§†é¢‘</span>
            <span class="app-tag" onclick="selectApp(this, 'è…¾è®¯æ–°é—»')">è…¾è®¯æ–°é—»</span>
            <span class="app-tag" onclick="selectApp(this, 'å¾®è§†')">å¾®è§†</span>
            <span class="app-tag" onclick="selectApp(this, 'QQ')">QQ</span>
            <span class="app-tag" onclick="selectApp(this, 'é…·ç‹—éŸ³ä¹')">é…·ç‹—éŸ³ä¹</span>
          </div>
        </div>

        <div class="form-group hidden" id="otherAppGroup">
          <label class="required">è¯·è¾“å…¥APPåç§°</label>
          <input type="text" id="otherAppName" placeholder="è¯·è¾“å…¥æ‚¨ä½“éªŒçš„APPåç§°">
        </div>

        <div class="form-group">
          <label class="required">ä½“éªŒæ—¶é—´</label>
          <div class="time-row">
            <div class="form-group">
              <label style="font-size:13px;color:#666;margin-bottom:6px">å¼€å§‹æ—¶é—´</label>
              <input type="datetime-local" id="startTime">
            </div>
            <div class="form-group">
              <label style="font-size:13px;color:#666;margin-bottom:6px">ç»“æŸæ—¶é—´</label>
              <input type="datetime-local" id="endTime">
            </div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="goToStep3()">ä¸‹ä¸€æ­¥</button>
        <button class="btn btn-secondary" onclick="goBack('step-basic')">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤3: å¹¿å‘Šä½“éªŒè¯„åˆ† -->
    <div class="step-section" id="step-score">
      <div class="card">
        <h1>å¹¿å‘Šä½“éªŒè¯„åˆ†</h1>
        <p class="subtitle">è¯·å¯¹æœ¬æ¬¡å¹¿å‘Šä½“éªŒè¿›è¡Œè¯„åˆ†</p>
        
        <div class="step-indicator">
          <div class="step-dot completed"></div>
          <div class="step-dot completed"></div>
          <div class="step-dot active"></div>
          <div class="step-dot"></div>
        </div>

        <div class="alert alert-info">
          <strong>è¯„åˆ†è¯´æ˜ï¼š</strong><br>
          0-6åˆ†ï¼šä¸æ»¡æ„ï¼Œéœ€è¦æ”¹è¿›<br>
          7-10åˆ†ï¼šæ»¡æ„ï¼Œä½“éªŒè‰¯å¥½
        </div>

        <div class="form-group">
          <label class="required">æ»¡æ„åº¦è¯„åˆ†</label>
          <div class="score-display" id="scoreDisplay">5</div>
          <input type="range" min="0" max="10" value="5" id="scoreSlider" onchange="updateScore(this.value)" oninput="updateScore(this.value)">
          <div class="score-labels">
            <span>0 éå¸¸ä¸æ»¡æ„</span>
            <span>10 éå¸¸æ»¡æ„</span>
          </div>
        </div>

        <button class="btn btn-primary" onclick="goToStep4()">ä¸‹ä¸€æ­¥</button>
        <button class="btn btn-secondary" onclick="goBack('step-app')">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤4a: ä¸æ»¡æ„åŸå›  (0-6åˆ†) -->
    <div class="step-section" id="step-dissatisfied">
      <div class="card">
        <h1>ä¸æ»¡æ„åŸå› åé¦ˆ</h1>
        <p class="subtitle">è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨ä¸æ»¡æ„çš„åŸå› ï¼ˆå¯å¤šé€‰ï¼‰</p>
        
        <div class="step-indicator">
          <div class="step-dot completed"></div>
          <div class="step-dot completed"></div>
          <div class="step-dot completed"></div>
          <div class="step-dot active"></div>
        </div>

        <div class="alert alert-warning">
          æ‚¨çš„è¯„åˆ†ï¼š<strong id="showScoreDis">0</strong> åˆ†<br>
          è¯·å¸®åŠ©æˆ‘ä»¬äº†è§£ä¸æ»¡æ„çš„åŸå› 
        </div>

        <div class="form-group">
          <label class="required">ä¸æ»¡æ„åŸå› ï¼ˆå¯å¤šé€‰ï¼‰</label>
          <div class="checkbox-group" id="dissatisfiedReasons">
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="ç›¸åŒå†…å®¹é‡å¤å¤šæ¬¡æ¨è">
              <span>ç›¸åŒå†…å®¹é‡å¤å¤šæ¬¡æ¨è</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="å¹¿å‘Šå‡ºç°é¢‘æ¬¡è¿‡é«˜">
              <span>å¹¿å‘Šå‡ºç°é¢‘æ¬¡è¿‡é«˜</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="å¹¿å‘Šå‡ºç°å¾ˆçªå…€ï¼Œä¸ä¸Šä¸‹æ–‡ä¸ç›¸å…³">
              <span>å¹¿å‘Šå‡ºç°å¾ˆçªå…€ï¼Œä¸ä¸Šä¸‹æ–‡ä¸ç›¸å…³</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="æ¨èçš„å¹¿å‘Šä¸æ˜¯æˆ‘æ„Ÿå…´è¶£çš„">
              <span>æ¨èçš„å¹¿å‘Šä¸æ˜¯æˆ‘æ„Ÿå…´è¶£çš„</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="ç´ ææ ·å¼å½±å“é˜…è¯»">
              <span>ç´ ææ ·å¼å½±å“é˜…è¯»</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="å¹¿å‘Šå†…å®¹ä½è´¨/è™šå‡">
              <span>å¹¿å‘Šå†…å®¹ä½è´¨/è™šå‡</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="dissatisfied" value="å…¶ä»–">
              <span>å…¶ä»–ï¼ˆè¯·è¯´æ˜ï¼‰</span>
            </label>
          </div>
        </div>

        <div class="form-group hidden" id="otherReasonDis">
          <label class="required">å…¶ä»–åŸå› è¯´æ˜</label>
          <textarea id="otherTextDis" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨ä¸æ»¡æ„çš„åŸå› ..."></textarea>
        </div>

        <div class="form-group">
          <label class="required">è¯·ä¸Šä¼ ç›¸å…³æˆªå›¾</label>
          <div class="upload-area" id="uploadAreaDis" onclick="document.getElementById('fileInputDis').click()">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æˆªå›¾<br>ï¼ˆæœ€å¤š5å¼ ï¼‰</div>
          </div>
          <input type="file" id="fileInputDis" accept="image/*" multiple style="display:none" onchange="handleFileSelect(this, 'dis')">
          <div class="preview-grid" id="previewGridDis"></div>
        </div>

        <button class="btn btn-primary" onclick="submitSurvey('dissatisfied')" id="btnSubmitDis">æäº¤é—®å·</button>
        <button class="btn btn-secondary" onclick="goBack('step-score')">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </div>

    <!-- æ­¥éª¤4b: æ»¡æ„åŸå›  (7-10åˆ†) -->
    <div class="step-section" id="step-satisfied">
      <div class="card">
        <h1>æ»¡æ„åŸå› åé¦ˆ</h1>
        <p class="subtitle">è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨æ»¡æ„çš„åŸå› ï¼ˆå¯å¤šé€‰ï¼‰</p>
        
        <div class="step-indicator">
          <div class="step-dot completed"></div>
          <div class="step-dot completed"></div>
          <div class="step-dot completed"></div>
          <div class="step-dot active"></div>
        </div>

        <div class="alert alert-success">
          æ‚¨çš„è¯„åˆ†ï¼š<strong id="showScoreSat">0</strong> åˆ†<br>
          æ„Ÿè°¢æ‚¨çš„è®¤å¯ï¼è¯·é€‰æ‹©æ»¡æ„çš„åŸå› 
        </div>

        <div class="form-group">
          <label class="required">æ»¡æ„åŸå› ï¼ˆå¯å¤šé€‰ï¼‰</label>
          <div class="checkbox-group" id="satisfiedReasons">
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="å¹¿å‘Šé¢‘ç‡é€‚ä¸­">
              <span>å¹¿å‘Šé¢‘ç‡é€‚ä¸­</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="å¹¿å‘Šå‡ºç°ä¸ä¸Šä¸‹æ–‡ç›¸å…³ï¼Œä¸æ‰“æ‰°">
              <span>å¹¿å‘Šå‡ºç°ä¸ä¸Šä¸‹æ–‡ç›¸å…³ï¼Œä¸æ‰“æ‰°</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="æ¨èç²¾å‡†ç¬¦åˆå…´è¶£">
              <span>æ¨èç²¾å‡†ç¬¦åˆå…´è¶£</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="ç´ ææ ·å¼ç¾è§‚">
              <span>ç´ ææ ·å¼ç¾è§‚</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="å¹¿å‘Šå†…å®¹æœ‰ä»·å€¼">
              <span>å¹¿å‘Šå†…å®¹æœ‰ä»·å€¼</span>
            </label>
            <label class="checkbox-item" onclick="toggleCheckbox(this)">
              <input type="checkbox" name="satisfied" value="å…¶ä»–">
              <span>å…¶ä»–ï¼ˆè¯·è¯´æ˜ï¼‰</span>
            </label>
          </div>
        </div>

        <div class="form-group hidden" id="otherReasonSat">
          <label>å…¶ä»–åŸå› è¯´æ˜</label>
          <textarea id="otherTextSat" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨æ»¡æ„çš„åŸå› ..."></textarea>
        </div>

        <div class="form-group">
          <label class="required">è¯·ä¸Šä¼ ç›¸å…³æˆªå›¾</label>
          <div class="upload-area" id="uploadAreaSat" onclick="document.getElementById('fileInputSat').click()">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æˆªå›¾<br>ï¼ˆæœ€å¤š5å¼ ï¼‰</div>
          </div>
          <input type="file" id="fileInputSat" accept="image/*" multiple style="display:none" onchange="handleFileSelect(this, 'sat')">
          <div class="preview-grid" id="previewGridSat"></div>
        </div>

        <button class="btn btn-primary" onclick="submitSurvey('satisfied')" id="btnSubmitSat">æäº¤é—®å·</button>
        <button class="btn btn-secondary" onclick="goBack('step-score')">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>
    </div>

    <!-- æäº¤æˆåŠŸ -->
    <div class="step-section" id="step-success">
      <div class="card">
        <div class="success-message">
          <div class="success-icon">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
          </div>
          <h2>æäº¤æˆåŠŸï¼</h2>
          <p>æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæ‚¨çš„æ„è§å¯¹æˆ‘ä»¬éå¸¸é‡è¦</p>
        </div>
        
        <button class="btn btn-primary" onclick="resetSurvey()" style="margin-top: 30px;">å†å¡«ä¸€ä»½</button>
      </div>
    </div>
  </div>

  <script>
    // ============ æ•°æ®åº“æ¨¡å— ============
    const SurveyDB = {
      dbName: 'app_survey_db',
      
      // è·å–è®¾å¤‡IDï¼ˆä½¿ç”¨æŒ‡çº¹æŠ€æœ¯ï¼‰
      getDeviceId() {
        let deviceId = localStorage.getItem(`${this.dbName}_device_id`);
        if (!deviceId) {
          // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          ctx.textBaseline = 'top';
          ctx.font = '14px Arial';
          ctx.fillText('DeviceFingerprint', 2, 2);
          const canvasData = canvas.toDataURL();
          
          // ç»„åˆå¤šä¸ªå› ç´ ç”Ÿæˆå”¯ä¸€ID
          const factors = [
            navigator.userAgent,
            navigator.language,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            canvasData.substring(0, 50)
          ].join('|');
          
          // ç®€å•å“ˆå¸Œ
          let hash = 0;
          for (let i = 0; i < factors.length; i++) {
            const char = factors.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
          }
          
          deviceId = 'DEV_' + Math.abs(hash).toString(36).toUpperCase() + '_' + Date.now().toString(36).toUpperCase();
          localStorage.setItem(`${this.dbName}_device_id`, deviceId);
        }
        return deviceId;
      },
      
      // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æäº¤è¿‡
      hasDeviceSubmitted() {
        const responses = this.getResponses();
        const deviceId = this.getDeviceId();
        return responses.some(r => r.deviceId === deviceId);
      },
      
      // è·å–æ‰€æœ‰é—®å·å“åº”
      getResponses() {
        try {
          const data = localStorage.getItem(`${this.dbName}_responses`);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      },
      
      // ä¿å­˜é—®å·å“åº”
      saveResponse(response) {
        try {
          const responses = this.getResponses();
          const wuid = 'W' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
          
          const newResponse = {
            id: Date.now().toString(),
            wuid: wuid,
            deviceId: this.getDeviceId(),
            ...response,
            uploadTime: new Date().toISOString()
          };
          
          responses.push(newResponse);
          localStorage.setItem(`${this.dbName}_responses`, JSON.stringify(responses));
          return { success: true, wuid: wuid };
        } catch (e) {
          console.error('ä¿å­˜å¤±è´¥:', e);
          return { success: false, error: e.message };
        }
      },
      
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
      saveUserCache(userData) {
        localStorage.setItem(`${this.dbName}_user_cache`, JSON.stringify(userData));
      },
      
      // è·å–ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
      getUserCache() {
        try {
          const data = localStorage.getItem(`${this.dbName}_user_cache`);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          return null;
        }
      }
    };

    // ============ é—®å·é€»è¾‘ ============
    let currentStep = 'step-basic';
    let selectedApp = '';
    let satisfactionScore = 5;
    let uploadedFilesDis = [];
    let uploadedFilesSat = [];

    // åˆå§‹åŒ–
    function init() {
      // æ˜¾ç¤ºè®¾å¤‡ID
      const deviceId = SurveyDB.getDeviceId();
      document.getElementById('deviceIdDisplay').textContent = deviceId;
      
      // æ£€æŸ¥æ˜¯å¦å·²æäº¤è¿‡
      if (SurveyDB.hasDeviceSubmitted()) {
        document.getElementById('duplicateWarning').classList.remove('hidden');
      }
      
      // æ¢å¤ç”¨æˆ·ç¼“å­˜
      const userCache = SurveyDB.getUserCache();
      if (userCache) {
        document.getElementById('userName').value = userCache.name || '';
        document.getElementById('userPhone').value = userCache.phone || '';
        document.getElementById('userWechat').value = userCache.wechat || '';
        document.getElementById('userWuid').value = userCache.wuid || '';
        checkDualInput();
      }
      
      // è®¾ç½®é»˜è®¤æ—¶é—´
      setDefaultTimes();
    }

    // è®¾ç½®é»˜è®¤æ—¶é—´
    function setDefaultTimes() {
      const now = new Date();
      const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
      
      document.getElementById('startTime').value = formatDateTimeLocal(thirtyMinutesAgo);
      document.getElementById('endTime').value = formatDateTimeLocal(now);
    }

    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // åˆ‡æ¢æ­¥éª¤
    function showStep(stepId) {
      document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
      currentStep = stepId;
      window.scrollTo(0, 0);
    }

    // è¿”å›ä¸Šä¸€æ­¥
    function goBack(stepId) {
      showStep(stepId);
    }

    // æ£€æŸ¥åŒè¾“å…¥æ¡†
    function checkDualInput() {
      const wechat = document.getElementById('userWechat').value.trim();
      const wuid = document.getElementById('userWuid').value.trim();
      const hint = document.getElementById('dualInputHint');
      
      if (wechat || wuid) {
        hint.textContent = 'å·²å¡«å†™';
        hint.className = 'input-hint success';
      } else {
        hint.textContent = 'è¯·è‡³å°‘å¡«å†™å¾®ä¿¡å·æˆ–WUIDä¸­çš„ä¸€é¡¹';
        hint.className = 'input-hint';
      }
    }

    // æ­¥éª¤1 -> æ­¥éª¤2
    function goToStep2() {
      const name = document.getElementById('userName').value.trim();
      const phone = document.getElementById('userPhone').value.trim();
      const wechat = document.getElementById('userWechat').value.trim();
      const wuid = document.getElementById('userWuid').value.trim();

      if (!name) {
        alert('è¯·è¾“å…¥å§“å');
        return;
      }

      if (!phone) {
        alert('è¯·è¾“å…¥æ‰‹æœºå·');
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
      }

      if (!wechat && !wuid) {
        alert('è¯·è‡³å°‘å¡«å†™å¾®ä¿¡å·æˆ–WUIDä¸­çš„ä¸€é¡¹');
        document.getElementById('dualInputHint').className = 'input-hint error';
        return;
      }

      // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
      SurveyDB.saveUserCache({
        name: name,
        phone: phone,
        wechat: wechat,
        wuid: wuid
      });

      showStep('step-app');
    }

    // é€‰æ‹©APP
    function selectApp(el, appName) {
      document.querySelectorAll('.app-tag').forEach(tag => tag.classList.remove('selected'));
      el.classList.add('selected');
      selectedApp = appName;

      if (appName === 'å…¶ä»–') {
        document.getElementById('otherAppGroup').classList.remove('hidden');
      } else {
        document.getElementById('otherAppGroup').classList.add('hidden');
      }
    }

    // æ­¥éª¤2 -> æ­¥éª¤3
    function goToStep3() {
      if (!selectedApp) {
        alert('è¯·é€‰æ‹©ä½“éªŒçš„APP');
        return;
      }

      if (selectedApp === 'å…¶ä»–') {
        const otherApp = document.getElementById('otherAppName').value.trim();
        if (!otherApp) {
          alert('è¯·è¾“å…¥APPåç§°');
          return;
        }
        selectedApp = otherApp;
      }

      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startTime || !endTime) {
        alert('è¯·é€‰æ‹©ä½“éªŒçš„å¼€å§‹å’Œç»“æŸæ—¶é—´');
        return;
      }

      if (new Date(startTime) >= new Date(endTime)) {
        alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
        return;
      }

      showStep('step-score');
    }

    // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
    function updateScore(value) {
      satisfactionScore = parseInt(value);
      const display = document.getElementById('scoreDisplay');
      display.textContent = value;
      
      if (value <= 3) {
        display.style.color = '#f44336';
      } else if (value <= 6) {
        display.style.color = '#ff9800';
      } else {
        display.style.color = '#4caf50';
      }
    }

    // æ­¥éª¤3 -> æ­¥éª¤4
    function goToStep4() {
      if (satisfactionScore <= 6) {
        document.getElementById('showScoreDis').textContent = satisfactionScore;
        showStep('step-dissatisfied');
      } else {
        document.getElementById('showScoreSat').textContent = satisfactionScore;
        showStep('step-satisfied');
      }
    }

    // åˆ‡æ¢å¤é€‰æ¡†
    function toggleCheckbox(el) {
      const checkbox = el.querySelector('input');
      checkbox.checked = !checkbox.checked;
      el.classList.toggle('selected', checkbox.checked);

      const value = checkbox.value;
      if (value === 'å…¶ä»–') {
        const type = checkbox.name === 'dissatisfied' ? 'Dis' : 'Sat';
        document.getElementById('otherReason' + type).classList.toggle('hidden', !checkbox.checked);
      }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(input, type) {
      const files = Array.from(input.files);
      const uploadedFiles = type === 'dis' ? uploadedFilesDis : uploadedFilesSat;
      
      if (uploadedFiles.length + files.length > 5) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡');
        return;
      }

      files.forEach(file => {
        if (uploadedFiles.length < 5) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedFiles.push({
              name: file.name,
              data: e.target.result
            });
            updatePreviewGrid(type);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // æ›´æ–°é¢„è§ˆç½‘æ ¼
    function updatePreviewGrid(type) {
      const uploadedFiles = type === 'dis' ? uploadedFilesDis : uploadedFilesSat;
      const grid = document.getElementById('previewGrid' + (type === 'dis' ? 'Dis' : 'Sat'));
      
      grid.innerHTML = '';
      uploadedFiles.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        
        const img = document.createElement('img');
        img.src = file.data;
        
        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.textContent = 'Ã—';
        btn.onclick = (e) => {
          e.stopPropagation();
          removeFile(type, index);
        };

        div.appendChild(img);
        div.appendChild(btn);
        grid.appendChild(div);
      });
    }

    // ç§»é™¤æ–‡ä»¶
    function removeFile(type, index) {
      if (type === 'dis') {
        uploadedFilesDis.splice(index, 1);
      } else {
        uploadedFilesSat.splice(index, 1);
      }
      updatePreviewGrid(type);
    }

    // æäº¤é—®å·
    async function submitSurvey(type) {
      const btnId = type === 'dissatisfied' ? 'btnSubmitDis' : 'btnSubmitSat';
      const btn = document.getElementById(btnId);
      
      const checkboxName = type === 'dissatisfied' ? 'dissatisfied' : 'satisfied';
      const checked = Array.from(document.querySelectorAll(`input[name="${checkboxName}"]:checked`))
        .map(cb => cb.value);

      if (checked.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåŸå› ');
        return;
      }

      const otherText = type === 'dissatisfied' 
        ? document.getElementById('otherTextDis').value.trim()
        : document.getElementById('otherTextSat').value.trim();

      if (checked.includes('å…¶ä»–') && !otherText) {
        alert('è¯·å¡«å†™å…¶ä»–åŸå› è¯´æ˜');
        return;
      }

      // éªŒè¯æˆªå›¾ä¸Šä¼ 
      const uploadedFiles = type === 'dissatisfied' ? uploadedFilesDis : uploadedFilesSat;
      if (uploadedFiles.length === 0) {
        alert('è¯·ä¸Šä¼ è‡³å°‘ä¸€å¼ ç›¸å…³æˆªå›¾');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>æäº¤ä¸­...';

      const userCache = SurveyDB.getUserCache();
      
      const response = {
        // åŸºç¡€ä¿¡æ¯
        userName: userCache?.name || '',
        userPhone: userCache?.phone || '',
        userWechat: userCache?.wechat || '',
        userWuid: userCache?.wuid || '',
        // APPä½“éªŒè®°å½•
        appName: selectedApp,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        // è¯„åˆ†å’ŒåŸå› 
        score: satisfactionScore,
        dissatisfiedReasons: type === 'dissatisfied' ? checked.filter(r => r !== 'å…¶ä»–').join(',') : '',
        satisfiedReasons: type === 'satisfied' ? checked.filter(r => r !== 'å…¶ä»–').join(',') : '',
        otherReason: checked.includes('å…¶ä»–') ? otherText : '',
        // æˆªå›¾æ•°æ®
        screenshots: uploadedFiles.map(f => f.data)
      };

      try {
        const result = SurveyDB.saveResponse(response);
        if (result.success) {
          showStep('step-success');
        } else {
          throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        console.error('æäº¤å¤±è´¥:', e);
        alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        btn.disabled = false;
        btn.textContent = 'æäº¤é—®å·';
      }
    }

    // é‡ç½®é—®å·
    function resetSurvey() {
      selectedApp = '';
      satisfactionScore = 5;

      // é‡ç½®APPé€‰æ‹©
      document.querySelectorAll('.app-tag').forEach(tag => tag.classList.remove('selected'));
      document.getElementById('otherAppGroup').classList.add('hidden');
      document.getElementById('otherAppName').value = '';

      // é‡ç½®æ—¶é—´
      setDefaultTimes();

      // é‡ç½®è¯„åˆ†
      document.getElementById('scoreSlider').value = 5;
      document.getElementById('scoreDisplay').textContent = '5';
      document.getElementById('scoreDisplay').style.color = '#667eea';

      // é‡ç½®å¤é€‰æ¡†
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('.checkbox-item').forEach(item => item.classList.remove('selected'));

      // é‡ç½®å…¶ä»–åŸå› 
      document.getElementById('otherReasonDis').classList.add('hidden');
      document.getElementById('otherReasonSat').classList.add('hidden');
      document.getElementById('otherTextDis').value = '';
      document.getElementById('otherTextSat').value = '';

      // é‡ç½®æŒ‰é’®
      document.getElementById('btnSubmitDis').disabled = false;
      document.getElementById('btnSubmitDis').textContent = 'æäº¤é—®å·';
      document.getElementById('btnSubmitSat').disabled = false;
      document.getElementById('btnSubmitSat').textContent = 'æäº¤é—®å·';

      // é‡ç½®æˆªå›¾ä¸Šä¼ 
      uploadedFilesDis = [];
      uploadedFilesSat = [];
      document.getElementById('previewGridDis').innerHTML = '';
      document.getElementById('previewGridSat').innerHTML = '';

      showStep('step-app');
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
