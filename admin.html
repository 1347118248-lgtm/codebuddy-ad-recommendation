<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>问卷数据看板</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header p {
      opacity: 0.9;
      margin-top: 5px;
      font-size: 14px;
    }

    .header-actions {
      margin-top: 10px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .header-actions a {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      font-size: 14px;
    }

    .header-actions a:hover {
      text-decoration: underline;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .stat-card .label {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .stat-card .value.positive {
      color: #4caf50;
    }

    .stat-card .value.negative {
      color: #f44336;
    }

    .stat-card .value.neutral {
      color: #667eea;
    }

    /* 通用卡片 */
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    /* 筛选器 */
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input[type="date"], select {
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    input[type="date"]:focus, select:focus {
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e8e8e8;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background: #43a047;
    }

    /* 图表区域 */
    .chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    /* 柱状图 */
    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bar-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bar-label {
      width: 100px;
      font-size: 13px;
      color: #666;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bar-wrapper {
      flex: 1;
      height: 28px;
      background: #f0f0f0;
      border-radius: 14px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 14px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-size: 12px;
      font-weight: 500;
    }

    .bar-value {
      width: 60px;
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }

    /* 日期趋势图 */
    .trend-chart {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 20px 0;
      border-bottom: 1px solid #eee;
    }

    .trend-bar {
      flex: 1;
      background: linear-gradient(to top, #667eea, #764ba2);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: height 0.3s;
      cursor: pointer;
      position: relative;
    }

    .trend-bar:hover {
      opacity: 0.8;
    }

    .trend-bar .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .trend-bar:hover .tooltip {
      opacity: 1;
    }

    .trend-labels {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      font-size: 11px;
      color: #999;
    }

    /* 用户原声 */
    .voice-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .voice-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #667eea;
    }

    .voice-item.negative {
      border-left-color: #f44336;
      background: #fff8f8;
    }

    .voice-item.positive {
      border-left-color: #4caf50;
      background: #f8fff8;
    }

    .voice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .voice-app {
      font-weight: 600;
      color: #333;
    }

    .voice-score {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .voice-score.low {
      background: #ffebee;
      color: #c62828;
    }

    .voice-score.high {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .voice-content {
      color: #555;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .voice-meta {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #999;
    }

    /* 表格 */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    td {
      font-size: 14px;
      color: #333;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-app {
      background: #e3f2fd;
      color: #1565c0;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 14px;
    }

    .score-low {
      background: #ffebee;
      color: #c62828;
    }

    .score-medium {
      background: #fff3e0;
      color: #e65100;
    }

    .score-high {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .reasons-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      max-width: 300px;
    }

    .reason-tag {
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .reason-tag.dis {
      background: #ffebee;
      color: #c62828;
    }

    .reason-tag.sat {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* 截图相关 */
    .screenshots-cell {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .screenshot-thumb {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      object-fit: cover;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: transform 0.2s;
    }

    .screenshot-thumb:hover {
      transform: scale(1.1);
    }

    .screenshot-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
    }

    /* 图片预览模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 85vh;
      border-radius: 8px;
    }

    .modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 30px;
      cursor: pointer;
      background: none;
      border: none;
    }

    .modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .modal-nav:hover {
      background: rgba(255,255,255,0.4);
    }

    .modal-nav.prev {
      left: -70px;
    }

    .modal-nav.next {
      right: -70px;
    }

    .modal-counter {
      text-align: center;
      color: white;
      margin-top: 15px;
      font-size: 14px;
    }

    /* 分页 */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .pagination button:hover:not(:disabled) {
      background: #f5f5f5;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-info {
      color: #666;
      font-size: 14px;
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 60px;
      height: 60px;
      fill: #ddd;
      margin-bottom: 15px;
    }

    /* Tab切换 */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* APP选择器 */
    .app-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .app-filter-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .app-filter-btn:hover {
      border-color: #667eea;
    }

    .app-filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .card {
        padding: 16px;
      }

      .chart-container {
        grid-template-columns: 1fr;
      }

      .filters {
        width: 100%;
      }

      .filters input, .filters select, .filters .btn {
        flex: 1;
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>APP体验问卷数据看板</h1>
    <p>数据分析与可视化</p>
    <div class="header-actions">
      <a href="index.html">← 返回问卷页面</a>
    </div>
  </div>

  <div class="container">
    <!-- 筛选器 -->
    <div class="card">
      <div class="filters">
        <input type="date" id="startDate">
        <span style="line-height:40px;color:#666">至</span>
        <input type="date" id="endDate">
        <select id="appFilter">
          <option value="">全部APP</option>
        </select>
        <button class="btn btn-primary" onclick="loadData()">筛选</button>
        <button class="btn btn-secondary" onclick="refreshData()">刷新</button>
        <button class="btn btn-success" onclick="exportData()">导出CSV</button>
      </div>
    </div>

    <!-- 统计卡片 -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">总问卷数</div>
        <div class="value neutral" id="totalCount">0</div>
      </div>
      <div class="stat-card">
        <div class="label">平均评分</div>
        <div class="value" id="avgScore">-</div>
      </div>
      <div class="stat-card">
        <div class="label">满意人数 (7-10分)</div>
        <div class="value positive" id="satisfiedCount">0</div>
      </div>
      <div class="stat-card">
        <div class="label">不满意人数 (0-6分)</div>
        <div class="value negative" id="dissatisfiedCount">0</div>
      </div>
    </div>

    <!-- Tab切换 -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('overview')">数据概览</div>
      <div class="tab" onclick="switchTab('daily')">按天统计</div>
      <div class="tab" onclick="switchTab('app')">按APP统计</div>
      <div class="tab" onclick="switchTab('voice')">用户原声</div>
      <div class="tab" onclick="switchTab('list')">数据列表</div>
    </div>

    <!-- 数据概览 -->
    <div class="tab-content active" id="tab-overview">
      <div class="chart-container">
        <div class="chart-card">
          <div class="chart-title">评分分布</div>
          <div class="bar-chart" id="scoreDistChart"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">APP体验统计</div>
          <div class="bar-chart" id="appStatsChart"></div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-card">
          <div class="chart-title">主要不满意原因</div>
          <div class="bar-chart" id="dissatisfiedChart"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">主要满意原因</div>
          <div class="bar-chart" id="satisfiedChart"></div>
        </div>
      </div>
    </div>

    <!-- 按天统计 -->
    <div class="tab-content" id="tab-daily">
      <div class="card">
        <div class="chart-title">每日问卷提交量趋势</div>
        <div class="trend-chart" id="dailyTrendChart"></div>
        <div class="trend-labels" id="dailyTrendLabels"></div>
      </div>

      <div class="card">
        <div class="chart-title">每日各APP评分趋势</div>
        <div id="dailyAppTable"></div>
      </div>
    </div>

    <!-- 按APP统计 -->
    <div class="tab-content" id="tab-app">
      <div class="app-filter" id="appFilterButtons"></div>

      <div class="chart-container">
        <div class="chart-card">
          <div class="chart-title" id="appDetailTitle">APP详情</div>
          <div class="bar-chart" id="appDetailChart"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">该APP主要反馈原因</div>
          <div class="bar-chart" id="appReasonsChart"></div>
        </div>
      </div>
    </div>

    <!-- 用户原声 -->
    <div class="tab-content" id="tab-voice">
      <div class="card">
        <div class="card-header">
          <div class="card-title">"其他请说明" 用户原声摘取</div>
          <select id="voiceFilter" onchange="filterVoice()">
            <option value="all">全部反馈</option>
            <option value="dissatisfied">不满意反馈</option>
            <option value="satisfied">满意反馈</option>
          </select>
        </div>
        <div class="voice-list" id="voiceList"></div>
      </div>
    </div>

    <!-- 数据列表 -->
    <div class="tab-content" id="tab-list">
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>系统WUID</th>
                <th>姓名</th>
                <th>手机号</th>
                <th>微信号</th>
                <th>用户WUID</th>
                <th>APP</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>评分</th>
                <th>原因</th>
                <th>截图</th>
                <th>提交时间</th>
              </tr>
            </thead>
            <tbody id="dataTable">
              <tr>
                <td colspan="12" class="empty-state">加载中...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <button onclick="prevPage()" id="prevBtn" disabled>上一页</button>
          <span class="page-info" id="pageInfo">第 1 页</span>
          <button onclick="nextPage()" id="nextBtn">下一页</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 图片预览模态框 -->
  <div class="modal" id="imageModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <button class="modal-nav prev" onclick="prevImage()">&#8249;</button>
      <img id="modalImage" src="" alt="截图预览">
      <button class="modal-nav next" onclick="nextImage()">&#8250;</button>
      <div class="modal-counter" id="modalCounter">1 / 1</div>
    </div>
  </div>

  <script>
    // ============ 数据库模块 ============
    const SurveyDB = {
      dbName: 'app_survey_db',
      
      getResponses() {
        try {
          const data = localStorage.getItem(`${this.dbName}_responses`);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      }
    };

    // ============ 全局变量 ============
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const pageSize = 20;
    let selectedAppForDetail = '';
    let currentImages = [];
    let currentImageIndex = 0;

    // ============ 初始化 ============
    async function init() {
      setDefaultDates();
      await loadData();
    }

    function setDefaultDates() {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('endDate').value = formatDate(today);
      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN');
    }

    // ============ 数据加载 ============
    async function loadData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const appFilter = document.getElementById('appFilter').value;

      allData = SurveyDB.getResponses();

      // 日期筛选
      filteredData = allData.filter(item => {
        const uploadDate = item.uploadTime?.split('T')[0];
        if (startDate && uploadDate < startDate) return false;
        if (endDate && uploadDate > endDate) return false;
        if (appFilter && item.appName !== appFilter) return false;
        return true;
      });

      // 按时间倒序
      filteredData.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));

      // 更新APP筛选器
      updateAppFilter();

      // 更新所有图表
      updateStats();
      renderScoreDistChart();
      renderAppStatsChart();
      renderReasonsCharts();
      renderDailyTrend();
      renderDailyAppTable();
      renderAppFilterButtons();
      renderVoiceList();
      renderTable();
    }

    async function refreshData() {
      await loadData();
    }

    // 更新APP筛选器
    function updateAppFilter() {
      const select = document.getElementById('appFilter');
      const apps = [...new Set(allData.map(d => d.appName).filter(Boolean))];
      
      select.innerHTML = '<option value="">全部APP</option>' + 
        apps.map(app => `<option value="${app}">${app}</option>`).join('');
    }

    // ============ 统计更新 ============
    function updateStats() {
      const total = filteredData.length;
      const satisfied = filteredData.filter(d => d.score >= 7).length;
      const dissatisfied = filteredData.filter(d => d.score < 7).length;
      const avgScore = total > 0 
        ? (filteredData.reduce((sum, d) => sum + (d.score || 0), 0) / total).toFixed(1)
        : '-';

      document.getElementById('totalCount').textContent = total;
      document.getElementById('satisfiedCount').textContent = satisfied;
      document.getElementById('dissatisfiedCount').textContent = dissatisfied;
      
      const avgEl = document.getElementById('avgScore');
      avgEl.textContent = avgScore;
      if (avgScore !== '-') {
        avgEl.className = parseFloat(avgScore) >= 7 ? 'value positive' : 
                          parseFloat(avgScore) >= 4 ? 'value' : 'value negative';
        if (parseFloat(avgScore) >= 4 && parseFloat(avgScore) < 7) {
          avgEl.style.color = '#ff9800';
        }
      }
    }

    // ============ 评分分布图 ============
    function renderScoreDistChart() {
      const container = document.getElementById('scoreDistChart');
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div class="empty-state">暂无数据</div>';
        return;
      }

      const dist = {};
      for (let i = 0; i <= 10; i++) dist[i] = 0;
      filteredData.forEach(d => {
        if (d.score !== undefined) dist[d.score]++;
      });

      const maxCount = Math.max(...Object.values(dist), 1);

      container.innerHTML = Object.entries(dist)
        .filter(([, count]) => count > 0)
        .map(([score, count]) => {
          const percent = (count / maxCount) * 100;
          let color = '#4caf50';
          if (parseInt(score) <= 3) color = '#f44336';
          else if (parseInt(score) <= 6) color = '#ff9800';

          return `
            <div class="bar-item">
              <div class="bar-label">${score}分</div>
              <div class="bar-wrapper">
                <div class="bar-fill" style="width:${percent}%;background:${color}"></div>
              </div>
              <div class="bar-value">${count}人</div>
            </div>
          `;
        }).join('') || '<div class="empty-state">暂无数据</div>';
    }

    // ============ APP统计图 ============
    function renderAppStatsChart() {
      const container = document.getElementById('appStatsChart');
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div class="empty-state">暂无数据</div>';
        return;
      }

      const stats = {};
      filteredData.forEach(d => {
        const app = d.appName || '未知';
        if (!stats[app]) stats[app] = { count: 0, totalScore: 0 };
        stats[app].count++;
        stats[app].totalScore += d.score || 0;
      });

      const entries = Object.entries(stats).sort((a, b) => b[1].count - a[1].count);
      const maxCount = Math.max(...entries.map(([, s]) => s.count), 1);

      container.innerHTML = entries.slice(0, 10).map(([app, stat]) => {
        const percent = (stat.count / maxCount) * 100;
        const avgScore = (stat.totalScore / stat.count).toFixed(1);
        const color = avgScore >= 7 ? '#4caf50' : avgScore >= 4 ? '#ff9800' : '#f44336';

        return `
          <div class="bar-item">
            <div class="bar-label" title="${app}">${app}</div>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width:${percent}%;background:${color}">${stat.count}</div>
            </div>
            <div class="bar-value">${avgScore}分</div>
          </div>
        `;
      }).join('') || '<div class="empty-state">暂无数据</div>';
    }

    // ============ 原因分析图 ============
    function renderReasonsCharts() {
      const dissatisfiedReasons = {};
      const satisfiedReasons = {};

      filteredData.forEach(d => {
        if (d.dissatisfiedReasons) {
          d.dissatisfiedReasons.split(',').forEach(r => {
            if (r.trim()) dissatisfiedReasons[r.trim()] = (dissatisfiedReasons[r.trim()] || 0) + 1;
          });
        }
        if (d.satisfiedReasons) {
          d.satisfiedReasons.split(',').forEach(r => {
            if (r.trim()) satisfiedReasons[r.trim()] = (satisfiedReasons[r.trim()] || 0) + 1;
          });
        }
      });

      renderReasonsChart('dissatisfiedChart', dissatisfiedReasons, '#f44336');
      renderReasonsChart('satisfiedChart', satisfiedReasons, '#4caf50');
    }

    function renderReasonsChart(containerId, reasons, color) {
      const container = document.getElementById(containerId);
      const entries = Object.entries(reasons).sort((a, b) => b[1] - a[1]);

      if (entries.length === 0) {
        container.innerHTML = '<div class="empty-state">暂无数据</div>';
        return;
      }

      const maxCount = Math.max(...entries.map(([, c]) => c), 1);

      container.innerHTML = entries.slice(0, 8).map(([reason, count]) => {
        const percent = (count / maxCount) * 100;
        return `
          <div class="bar-item">
            <div class="bar-label" title="${reason}">${reason.length > 10 ? reason.substring(0, 10) + '...' : reason}</div>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width:${percent}%;background:${color}">${count}</div>
            </div>
            <div class="bar-value">${count}次</div>
          </div>
        `;
      }).join('');
    }

    // ============ 每日趋势 ============
    function renderDailyTrend() {
      const container = document.getElementById('dailyTrendChart');
      const labelsContainer = document.getElementById('dailyTrendLabels');

      if (filteredData.length === 0) {
        container.innerHTML = '<div class="empty-state" style="height:200px;display:flex;align-items:center;justify-content:center">暂无数据</div>';
        labelsContainer.innerHTML = '';
        return;
      }

      // 按日期分组
      const dailyStats = {};
      filteredData.forEach(d => {
        const date = d.uploadTime?.split('T')[0];
        if (date) {
          if (!dailyStats[date]) dailyStats[date] = { count: 0, totalScore: 0 };
          dailyStats[date].count++;
          dailyStats[date].totalScore += d.score || 0;
        }
      });

      const dates = Object.keys(dailyStats).sort();
      const maxCount = Math.max(...dates.map(d => dailyStats[d].count), 1);

      container.innerHTML = dates.map(date => {
        const stat = dailyStats[date];
        const height = (stat.count / maxCount) * 180;
        const avgScore = (stat.totalScore / stat.count).toFixed(1);
        return `
          <div class="trend-bar" style="height:${height}px" title="${date}">
            <div class="tooltip">${date}<br>${stat.count}份 / 平均${avgScore}分</div>
          </div>
        `;
      }).join('');

      // 显示日期标签
      if (dates.length > 0) {
        labelsContainer.innerHTML = `
          <span>${dates[0]}</span>
          <span>${dates[dates.length - 1]}</span>
        `;
      }
    }

    // ============ 每日APP表格 ============
    function renderDailyAppTable() {
      const container = document.getElementById('dailyAppTable');

      if (filteredData.length === 0) {
        container.innerHTML = '<div class="empty-state">暂无数据</div>';
        return;
      }

      // 收集所有APP和日期
      const apps = [...new Set(filteredData.map(d => d.appName).filter(Boolean))];
      const dates = [...new Set(filteredData.map(d => d.uploadTime?.split('T')[0]).filter(Boolean))].sort().slice(-7);

      // 计算每日每APP的平均分
      const matrix = {};
      dates.forEach(date => {
        matrix[date] = {};
        apps.forEach(app => {
          const items = filteredData.filter(d => d.uploadTime?.split('T')[0] === date && d.appName === app);
          if (items.length > 0) {
            const avg = items.reduce((sum, i) => sum + (i.score || 0), 0) / items.length;
            matrix[date][app] = avg.toFixed(1);
          }
        });
      });

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>日期</th>
                ${apps.map(app => `<th>${app}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${dates.map(date => `
                <tr>
                  <td>${date}</td>
                  ${apps.map(app => {
                    const score = matrix[date][app];
                    if (score === undefined) return '<td>-</td>';
                    const cls = parseFloat(score) >= 7 ? 'score-high' : parseFloat(score) >= 4 ? 'score-medium' : 'score-low';
                    return `<td><span class="score-badge ${cls}">${score}</span></td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    // ============ APP筛选按钮 ============
    function renderAppFilterButtons() {
      const container = document.getElementById('appFilterButtons');
      const apps = [...new Set(filteredData.map(d => d.appName).filter(Boolean))];

      container.innerHTML = `
        <button class="app-filter-btn ${selectedAppForDetail === '' ? 'active' : ''}" onclick="selectAppDetail('')">全部</button>
        ${apps.map(app => `
          <button class="app-filter-btn ${selectedAppForDetail === app ? 'active' : ''}" onclick="selectAppDetail('${app}')">${app}</button>
        `).join('')}
      `;

      renderAppDetailChart();
    }

    function selectAppDetail(app) {
      selectedAppForDetail = app;
      document.querySelectorAll('.app-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === (app || '全部'));
      });
      renderAppDetailChart();
    }

    function renderAppDetailChart() {
      const titleEl = document.getElementById('appDetailTitle');
      const container = document.getElementById('appDetailChart');
      const reasonsContainer = document.getElementById('appReasonsChart');

      const data = selectedAppForDetail 
        ? filteredData.filter(d => d.appName === selectedAppForDetail)
        : filteredData;

      titleEl.textContent = selectedAppForDetail ? `${selectedAppForDetail} 评分分布` : '全部APP评分分布';

      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state">暂无数据</div>';
        reasonsContainer.innerHTML = '<div class="empty-state">暂无数据</div>';
        return;
      }

      // 评分分布
      const dist = {};
      for (let i = 0; i <= 10; i++) dist[i] = 0;
      data.forEach(d => {
        if (d.score !== undefined) dist[d.score]++;
      });

      const maxCount = Math.max(...Object.values(dist), 1);

      container.innerHTML = Object.entries(dist)
        .filter(([, count]) => count > 0)
        .map(([score, count]) => {
          const percent = (count / maxCount) * 100;
          let color = '#4caf50';
          if (parseInt(score) <= 3) color = '#f44336';
          else if (parseInt(score) <= 6) color = '#ff9800';

          return `
            <div class="bar-item">
              <div class="bar-label">${score}分</div>
              <div class="bar-wrapper">
                <div class="bar-fill" style="width:${percent}%;background:${color}">${count}</div>
              </div>
              <div class="bar-value">${count}人</div>
            </div>
          `;
        }).join('');

      // 原因统计
      const reasons = {};
      data.forEach(d => {
        const allReasons = (d.dissatisfiedReasons || '') + ',' + (d.satisfiedReasons || '');
        allReasons.split(',').forEach(r => {
          if (r.trim()) reasons[r.trim()] = (reasons[r.trim()] || 0) + 1;
        });
      });

      const reasonEntries = Object.entries(reasons).sort((a, b) => b[1] - a[1]).slice(0, 6);
      const maxReasonCount = Math.max(...reasonEntries.map(([, c]) => c), 1);

      reasonsContainer.innerHTML = reasonEntries.map(([reason, count]) => {
        const percent = (count / maxReasonCount) * 100;
        return `
          <div class="bar-item">
            <div class="bar-label" title="${reason}">${reason.length > 8 ? reason.substring(0, 8) + '...' : reason}</div>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width:${percent}%;background:#667eea">${count}</div>
            </div>
            <div class="bar-value">${count}次</div>
          </div>
        `;
      }).join('') || '<div class="empty-state">暂无数据</div>';
    }

    // ============ 用户原声 ============
    function renderVoiceList() {
      filterVoice();
    }

    function filterVoice() {
      const container = document.getElementById('voiceList');
      const filter = document.getElementById('voiceFilter').value;

      let voices = filteredData.filter(d => d.otherReason && d.otherReason.trim());

      if (filter === 'dissatisfied') {
        voices = voices.filter(d => d.score < 7);
      } else if (filter === 'satisfied') {
        voices = voices.filter(d => d.score >= 7);
      }

      if (voices.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>暂无"其他请说明"的用户反馈</p></div>';
        return;
      }

      container.innerHTML = voices.map(v => {
        const isNegative = v.score < 7;
        return `
          <div class="voice-item ${isNegative ? 'negative' : 'positive'}">
            <div class="voice-header">
              <span class="voice-app">${v.appName || '未知APP'}</span>
              <span class="voice-score ${isNegative ? 'low' : 'high'}">${v.score}分</span>
            </div>
            <div class="voice-content">"${v.otherReason}"</div>
            <div class="voice-meta">
              <span>WUID: ${v.wuid || '-'}</span>
              <span>${formatDateTime(v.uploadTime)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============ 数据表格 ============
    function renderTable() {
      const tbody = document.getElementById('dataTable');
      const start = (currentPage - 1) * pageSize;
      const pageData = filteredData.slice(start, start + pageSize);

      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="12">
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                <p>暂无数据</p>
              </div>
            </td>
          </tr>
        `;
        updatePagination();
        return;
      }

      tbody.innerHTML = pageData.map((row, idx) => {
        let scoreClass = 'score-high';
        if (row.score <= 3) scoreClass = 'score-low';
        else if (row.score <= 6) scoreClass = 'score-medium';

        let reasons = [];
        if (row.dissatisfiedReasons) {
          reasons = row.dissatisfiedReasons.split(',').map(r => 
            `<span class="reason-tag dis">${r}</span>`
          );
        }
        if (row.satisfiedReasons) {
          reasons = row.satisfiedReasons.split(',').map(r => 
            `<span class="reason-tag sat">${r}</span>`
          );
        }
        if (row.otherReason) {
          reasons.push(`<span class="reason-tag" title="${row.otherReason}">其他</span>`);
        }

        // 截图显示
        let screenshotHtml = '-';
        if (row.screenshots && row.screenshots.length > 0) {
          const globalIdx = start + idx;
          const thumbs = row.screenshots.slice(0, 3).map((img, i) => 
            `<img class="screenshot-thumb" src="${img}" onclick="openImageModal(${globalIdx}, ${i})" alt="截图${i+1}">`
          ).join('');
          const more = row.screenshots.length > 3 
            ? `<span class="screenshot-count">+${row.screenshots.length - 3}</span>` 
            : '';
          screenshotHtml = `<div class="screenshots-cell">${thumbs}${more}</div>`;
        }

        return `
          <tr>
            <td>${row.wuid || '-'}</td>
            <td>${row.userName || '-'}</td>
            <td>${row.userPhone || '-'}</td>
            <td>${row.userWechat || '-'}</td>
            <td>${row.userWuid || '-'}</td>
            <td><span class="badge badge-app">${row.appName || '-'}</span></td>
            <td>${formatDateTime(row.startTime)}</td>
            <td>${formatDateTime(row.endTime)}</td>
            <td><span class="score-badge ${scoreClass}">${row.score}</span></td>
            <td><div class="reasons-list">${reasons.join('') || '-'}</div></td>
            <td>${screenshotHtml}</td>
            <td>${formatDateTime(row.uploadTime)}</td>
          </tr>
        `;
      }).join('');

      updatePagination();
    }

    // ============ 图片模态框 ============
    function openImageModal(dataIdx, imgIdx) {
      currentImages = filteredData[dataIdx].screenshots || [];
      currentImageIndex = imgIdx;
      updateModalImage();
      document.getElementById('imageModal').classList.add('active');
    }

    function closeModal(e) {
      if (!e || e.target.id === 'imageModal') {
        document.getElementById('imageModal').classList.remove('active');
      }
    }

    function updateModalImage() {
      document.getElementById('modalImage').src = currentImages[currentImageIndex];
      document.getElementById('modalCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
    }

    function prevImage() {
      if (currentImageIndex > 0) {
        currentImageIndex--;
        updateModalImage();
      }
    }

    function nextImage() {
      if (currentImageIndex < currentImages.length - 1) {
        currentImageIndex++;
        updateModalImage();
      }
    }

    // 键盘导航
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('imageModal').classList.contains('active')) return;
      if (e.key === 'Escape') closeModal();
      if (e.key === 'ArrowLeft') prevImage();
      if (e.key === 'ArrowRight') nextImage();
    });

    function updatePagination() {
      const totalPages = Math.ceil(filteredData.length / pageSize) || 1;
      document.getElementById('pageInfo').textContent = `第 ${currentPage} / ${totalPages} 页 (共 ${filteredData.length} 条)`;
      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    }

    // ============ Tab切换 ============
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    // ============ 导出CSV ============
    function exportData() {
      if (filteredData.length === 0) {
        alert('没有数据可导出');
        return;
      }

      const headers = ['系统WUID', '姓名', '手机号', '微信号', '用户WUID', 'APP名称', '开始时间', '结束时间', '评分', '不满意原因', '满意原因', '其他原因', '设备ID', '提交时间'];
      
      const csv = [
        headers.join(','),
        ...filteredData.map(row => [
          row.wuid || '',
          row.userName || '',
          row.userPhone || '',
          row.userWechat || '',
          row.userWuid || '',
          row.appName || '',
          row.startTime || '',
          row.endTime || '',
          row.score,
          `"${row.dissatisfiedReasons || ''}"`,
          `"${row.satisfiedReasons || ''}"`,
          `"${row.otherReason || ''}"`,
          row.deviceId || '',
          row.uploadTime || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `survey_data_${formatDate(new Date())}.csv`;
      link.click();
    }

    // 初始化
    init();
  </script>
</body>
</html>
